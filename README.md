# キックバイク乗りこなし判定AI

このリポジトリは、子どもがキックバイクに乗っている映像を解析し、ペダル付き自転車に乗れるようになる時期を推定するプロトタイプです。

## 要件定義

1. **入力データ**: 子どもとキックバイクが写っている動画。角度や大きさは問いません。
2. **出力**: 人物ごとのクラスタ ID と合格/不合格判定画像。
3. **機能要件**
   - 動画からフレームを抽出し、子どもとキックバイクを検出する。
   - バランス、ハンドル操作、蹴り出しの強さなど動きの特徴量を算出する。
   - ラベル付けを行わず、動画の特徴量からクラスタリングを行う。
   - 新しい動画を入力するとクラスタ ID を推定する推論用スクリプトを提供する。
4. **非機能要件**
   - Python 3 を使用し、映像処理には OpenCV、学習には PyTorch など一般的なパッケージを利用する。
   - 家庭のスマートフォンで撮影された角度や画角がまちまちな動画を想定する。
   - データセットを追加してもコード変更なしで学習と推論を切り替えられるようにする。

## プログラム構成

```
kickbike_analysis/
├── __init__.py
├── data_loader.py      # 動画読み込みとフレーム抽出
├── feature_extractor.py# YOLOv8 + ByteTrack による特徴量計算
├── cluster.py          # KMeans ベースのクラスタリング処理
├── train.py            # クラスタリングのエントリーポイント
└── infer.py            # 推論を行うスクリプト
```

- **data_loader.py**: 動画ファイルを読み込み、フレームやクリップに分割します。
- **feature_extractor.py**: YOLOv8 で人物・自転車を検出し、ByteTrack による追跡と
  YOLOv8-pose の骨格情報からバランス・リズム・姿勢等の特徴量を算出します。
- **cluster.py**: 平均特徴量を用いて KMeans でクラスタリングを行います。
- **train.py**: `cluster.py` を利用して動画をクラスタリングし、結果を保存します。
- **infer.py**: 学習済みのクラスタリングモデルを読み込み、新しい動画がどのクラスタに属するかを推定します。

モジュールを分離することで各要素を個別にテスト・拡張しやすい構成としています。


## データセット準備

各動画からフレーム単位の特徴量をあらかじめ抽出して ``.npy`` ファイルに保存する
スクリプト `prepare_dataset.py` を用意しています。動画フォルダは起動後に入力することもできます。
入力を省略した場合は `data/` フォルダが使用されます。

パスを引用符で囲んだり `.mp4` ファイル名を指定した場合でも、自動的にそのファイル
があるフォルダに変換されます。


```bash
python -m kickbike_analysis.prepare_dataset
# もしくはパスを直接指定
python -m kickbike_analysis.prepare_dataset "D:\\20250525_ビタミンiファクトリーイベント動画"
```

処理後、同ディレクトリに ``動画名.npy`` が作成されます。これらの特徴量は学習時に
自動的に読み込まれます。

## 使い方

推論だけを試す場合は `analyze_video.py` を実行します。Windows のフルパスも指定できます。

```bash
python -m kickbike_analysis.analyze_video "D:\\20250525_ビタミンiファクトリーイベント動画\\DJI_20010311100342_0003_D.MP4"
```

スクリプトは YOLOv8 と ByteTrack により人物と自転車を検出・追跡し、
骨格推定からバイクの傾きや蹴りのリズムを計算します。
各人物について合格か不合格かを判断し、判定結果を描画した画像を出力します。



## 学習の実行


学習用の動画フォルダを用意し、依存パッケージをインストールした上で `train.py` を実行します。ディレクトリは実行後に入力することも可能で、入力を省略すると `data/` が使用されます。`labels.csv` は不要で、フォルダ内の `*.mp4` をまとめてクラスタリングします。動画が存在しない、または動きが検出できない場合はエラーとなります。



```bash
# 依存ライブラリのインストール (リポジトリ直下に `requirements.txt` を同梱しています)
pip install -r requirements.txt

# フォルダ入力を促すモードで学習開始
python -m kickbike_analysis.train
# 直接パスを指定することも可能
python -m kickbike_analysis.train "D:\\20250525_ビタミンiファクトリーイベント動画"

```

学習が完了すると `clusters.pkl` が保存され、`infer.py` から利用できます。
推論では人物ごとのクラスタ ID と判定画像のパスを表示します。

### GPU の利用

クラスタリング処理は CPU 上で動作するため、特別な GPU 設定は不要です。
