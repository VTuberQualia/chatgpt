# キックバイク乗りこなし判定AI

このリポジトリは、子どもがキックバイクに乗っている映像を解析し、ペダル付き自転車に乗れるようになる時期を推定するプロトタイプです。

## 要件定義

1. **入力データ**: 子どもとキックバイクが写っている動画。角度や大きさは問いません。
2. **出力**: ペダル付き自転車に乗れるかどうかの二択（OK/NG）。
3. **機能要件**
   - 動画からフレームを抽出し、子どもとキックバイクを検出する。
   - バランス、ハンドル操作、蹴り出しの強さなど動きの特徴量を算出する。
   - 準備が整っているかどうかラベル付けされたデータを使い、特徴量と準備度の相関を学習する。
   - 新しい動画を入力すると準備度を推定する推論用スクリプトを提供する。
4. **非機能要件**
   - Python 3 を使用し、映像処理には OpenCV、学習には PyTorch など一般的なパッケージを利用する。
   - 家庭のスマートフォンで撮影された角度や画角がまちまちな動画を想定する。
   - データセットを追加してもコード変更なしで学習と推論を切り替えられるようにする。

## プログラム構成

```
kickbike_analysis/
├── __init__.py
├── data_loader.py      # 動画読み込みとフレーム抽出
├── feature_extractor.py# 物体検出・人物追跡・姿勢推定による特徴量計算
├── model.py            # 機械学習モデル定義
├── train.py            # 学習エントリーポイント
└── infer.py            # 推論を行うスクリプト
```

- **data_loader.py**: 動画ファイルを読み込み、フレームやクリップに分割します。
- **feature_extractor.py**: 人物検出と簡易トラッキング、姿勢角度算出を行い、数値特徴量を生成します。
- **model.py**: これらの特徴量を入力とする PyTorch 製のモデルを定義します。
- **train.py**: `data_loader` と `feature_extractor` を利用してラベル付きデータからモデルを学習します。
- **infer.py**: 学習済みモデルを読み込み、未知の動画に対してOK/NGを判定します。

モジュールを分離することで各要素を個別にテスト・拡張しやすい構成としています。

学習用ディレクトリには `labels.csv` を配置し、各動画ファイル名と`ok` または `ng` のラベルをカンマ区切りで記載してください。

## データセット準備

各動画からフレーム単位の特徴量をあらかじめ抽出して ``.npy`` ファイルに保存する
スクリプト `prepare_dataset.py` を用意しています。動画フォルダは起動後に入力することもできます。
入力を省略した場合は `data/` フォルダが使用されます。
パスを引用符で囲んだり `.mp4` ファイル名を指定した場合でも、自動的にそのファイル
があるフォルダに変換されます。

```bash
python -m kickbike_analysis.prepare_dataset
# もしくはパスを直接指定
python -m kickbike_analysis.prepare_dataset "D:\\20250525_ビタミンiファクトリーイベント動画"
```

処理後、同ディレクトリに ``動画名.npy`` が作成されます。これらの特徴量は学習時に
自動的に読み込まれます。

## 使い方

推論だけを試す場合は `analyze_video.py` を実行します。Windows のフルパスも指定できます。

```bash
python -m kickbike_analysis.analyze_video "D:\\20250525_ビタミンiファクトリーイベント動画\\DJI_20010311100342_0003_D.MP4"
```

スクリプトは物体検出による人物領域の追跡と、簡易的な姿勢角度の変化を特徴量として利用します。
揺れの大きさ、速度変化、体の傾きの安定度を総合的に評価し、判定理由も合わせて表示します。



## 学習の実行

学習用の動画と `labels.csv` をまとめたディレクトリを用意し、依存パッケージをインストールした上で `train.py` を実行します。ディレクトリは実行後に入力することも可能で、入力を省略すると `data/` が使用されます。ディレクトリには `*.mp4` 形式の動画と対応するラベルを記述した `labels.csv` を置いてください。動画が存在しない、または動きが検出できない場合はエラーとなります。パスを引用符付きで入力したり、単一の動画ファイルを指定した場合でも、そのファイルがあるフォルダを自動的に利用します。


```bash
# 依存ライブラリのインストール (リポジトリ直下に `requirements.txt` を同梱しています)
pip install -r requirements.txt

# フォルダ入力を促すモードで学習開始
python -m kickbike_analysis.train
# 直接パスを指定することも可能
python -m kickbike_analysis.train "D:\\20250525_ビタミンiファクトリーイベント動画"

```

学習が完了すると `model.pt` が保存され、`infer.py` から利用できます。
推論結果は OK/NG に加えて、揺れや姿勢の安定度など理由テキストも返されます。

### GPU の利用

`train.py` と `infer.py` は CUDA 対応 GPU が存在する場合、自動的に GPU を使用して
処理を行います。特別なオプションは不要で、PyTorch が GPU を認識できる環境であれ
ば高速化が期待できます。
