# キックバイク乗りこなし判定AI｜要件定義（改訂版）

最終更新: 2025-08-27（担当: あなた + アシスタント）

---

## 1. 背景と目的

* **背景**: キックバイク（ランバイク）に乗る子どもの映像から、ペダル付き自転車へ移行可能か（＝“乗りこなし度”）を判定したい。
* **目的**: 映像入力のみで、習熟度をスコア化し、次の練習ステップや安全アドバイスを提示する。
* **成果物**: (1) 推論モデル、(2) 推論API/バッチ推論器、(3) 解析レポート/可視化ダッシュボード、(4) アノテーションガイド。

---

## 2. スコープ

### 2.1 対象

* 子ども（おおむね2〜6歳）＋キックバイクの走行映像（スマホ撮影想定）。
* 屋外・屋内、直線・カーブ、単独走行中心。複数人映像は将来対応。

### 2.2 非対象（当面の除外）

* 交通状況理解や危険物検出などの高次安全認識。
* 個人特定、顔認証等の生体認証。
* 走行以外（整備、競技判定など）。

---

## 3. ユースケース

1. **親/コーチ向け評価**: 動画をアップ → 乗りこなしスコア（0–100）と判定カテゴリ（例: Beginner/Ready/Advance）を返す。
2. **練習プラン提案**: スコアに応じた“次にやるべき練習”と“安全ポイント”を提示。
3. **時系列トラッキング**: 継続アップロードで成長曲線を可視化（週/月単位）。

---

## 4. 主要指標（KPI）

* **一次指標**: 判定の正解率（Accuracy）、F1（3分類: Beginner/Almost/Ready）、AUC（Ready vs not）。
* **二次指標**: 説明性（提案の納得度アンケート≥80%）、処理時間（端末推論≤800ms/秒あたりのフレーム換算 or クラウド1本動画≤10s）。
* **運用指標**: アップロード成功率≥99%、異常検出による再撮影要求率≤10%。

---

## 5. 機能要件（FR）

* **FR-1**: 入力は動画（MP4/Mov、30〜120秒、≥720p）。
* **FR-2**: 人体・車体のキーポイント抽出（骨格推定＋車体位置/姿勢）。
* **FR-3**: 走行安定性の特徴量化（平均速度、速度変動、ふらつき量、ライン逸脱率、ストライド/蹴り頻度、連続グライド時間、左右バランス）。
* **FR-4**: カーブ・直線・停止/再発進のセグメンテーション。
* **FR-5**: 学習済み分類器で**乗りこなしスコア**（0–100）と**判定カテゴリ**（3〜4段階）を推定。
* **FR-6**: スコアに応じた**練習メニュー**と**安全アドバイス**を提示（3件以上）。
* **FR-7**: メタデータ出力（撮影条件、信頼度、品質判定）。
* **FR-8**: **品質チェック**（被写体小さすぎ・ブレ・逆光・被写体切れ）を検出し、リトライ指示。
* **FR-9**: **時系列比較**（ユーザーID単位で過去スコアと比較）。
* **FR-10**: **API**（REST/gRPC）およびバッチCLIを提供。

---

## 6. 非機能要件（NFR）

* **NFR-1 性能**: 1本動画（60秒, 30fps, 720p）あたりクラウド推論≤10秒（P95）。
* **NFR-2 可用性**: API稼働率 99.5%以上（商用β）。
* **NFR-3 可観測性**: 主要イベント（アップロード/解析/失敗）を構造化ログ+メトリクスで収集。
* **NFR-4 セキュリティ/プライバシ**: 児童の映像を扱うため、**最小保管**・**暗号化**・**自動マスキング（顔/名札）**を実装。
* **NFR-5 維持管理**: モデル/特徴量のバージョニング、実験トラッキング（例: MLflow互換）。
* **NFR-6 説明可能性**: スコア根拠の可視化（ふらつき時系列、姿勢ヒートマップ、イベント強調）。

---

## 7. データ要件

* **入力データ**: スマホ動画（縦横両対応、推奨横）。メタ情報（FPS/解像度/撮影環境タグ）。
* **アノテーション**:

  * (A) 乗りこなしラベル（人手: Ready/Almost/Beginner）。
  * (B) 走行イベント（直線/カーブ/停止/足つき/転倒）。
  * (C) 品質タグ（ブレ、逆光、遮蔽など）。
* **データ量目安**: 1本=30〜120秒、**教師データ500〜1,000本**（初期MVPは300本でも可）。
* **バイアス対策**: 年齢/身長/場所/天候/車種の偏りを監視し、分層サンプリング。
* **匿名化**: 顔・名札・背景看板の自動ぼかし（オプション）。

---

## 8. モデル要件（暫定）

* **骨格推定**: 軽量2Dポーズ推定（子ども体格最適化）。
* **マルチオブジェクト**: 子ども＋バイクを**一対のターゲット**として同時トラッキング。個別トラッカではなく、**ライダー+車体ペアID**を維持する設計（例: PairTrack, 強化ByteTrack）。
* **特徴抽出**: 時系列特徴（速度、横揺れ、上体角度、足つき頻度、グライド継続時間）。
* **長時間学習の工夫**:

  * 動画を短いセグメント（例: 5〜10秒）に分割して学習データ化。
  * 代表区間抽出（カーブ、直線、停止のシーンのみ利用）。
  * 時系列サンプリング（フレーム間引き、イベントトリガーサンプリング）。
  * Curriculum Learning（短時間→長時間へ段階的に学習）。
* **分類器**: 時系列モデル（Temporal CNN/Transformer）または勾配ブースティング（特徴量ベース）。
* **品質判定**: 別枝（画質/構図）で学習し、低品質は再撮影推奨に分岐。

### 8.2 RLベース判定（提案）

* **狙い**: 教師あり分類に加え、走行全体の一貫性を強化学習的に捉えて「ペダル付きへ移行できるか」を判定。
* **出力形式**: **合否判定（Ready=合格 / Not Ready=不合格）** を主とし、補助的にスコアを併記。
* **状態 s_t**: 骨格・車体キーポイント、速度/加速度、姿勢角、横振れ量、足つきフラグ、路面曲率、品質フラグ。
* **行動 a_t（代理）**: 推定される蹴りのタイミング/強度、体幹調整。
* **報酬 r_t**: 連続グライドの長さ（加点）、ふらつき・逸脱・過速度・足つき・転倒（減点）、安全性（大減点）。品質は重みで調整。
* **エピソードリターン R**: (R=Σ r_t) を Ready 度スコアにスケールし、合否にマッピング。
* **報酬校正**: ペアワイズ嗜好データによる報酬モデル学習 + 手工報酬のハイブリッド。軽量シミュで危険イベント係数を調整。
* **学習方針**: IQL/CQL などのオフラインRLで Q/Value 学習。Decision Transformer 等でリターン予測を併用。模倣学習で Ready データ分布を補強。
* **推論**: 動画を短クリップに分割→各 R を推定→分位点平均で頑健化。しきい値 θ_ready を ROC 最適化。最終出力は **合格/不合格**。
* **チューニング指標**: Macro-F1/AUC、pair-id維持率、IDスイッチ率、転倒見逃し率。年齢・身長正規化によるサブグループ評価。

### 8.3 多人数映像対応と個人スコアリング

* **課題**: 学習用動画は多人数が同時に走行しているケースが多い。個人ごとに切り分け、正しくスコアを算出する必要がある。
* **手法**:

  * 各人物＋バイクを **pair-id** としてトラッキングし、個別のトラジェクトリを抽出。
  * 個別のペアごとに特徴量・報酬系列を構築し、合否判定を出力。
  * IDスイッチを監視し、誤トラッキングを検知した場合はクリップを除外または再処理。
* **評価**: 各動画内の人物ごとに Precision/Recall を算出し、複数人同時走行下でも安定した性能を確認する。

### 8.4 学習データ生成プロセス

* **前処理**:

  * 学習用フォルダ内の動画を拡張子ごとに読み込み。
  * 各動画をランダムに 5〜10 秒単位に切り出し、学習クリップを生成。
  * 初期ステップとして約 1000 本のクリップを作成し、アノテーションを付与。
* **アノテーション**:

  * 個人ごとに Ready/Not Ready ラベルを付与。
  * イベント（足つき・転倒・ふらつき等）をタグ付け。
* **拡張**:

  * 今後は自動イベント検出＋弱教師ラベルで拡充し、データセット規模を増加させる。

---

以上の要件に合わせてリポジトリを整備・拡張していく。

